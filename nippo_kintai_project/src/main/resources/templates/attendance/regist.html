<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
	<link th:href="@{/css/style.css}" rel="stylesheet">
	<title>勤怠登録画面</title>
</head>

<body>
	<div class="container mt-3 mb-3">
		<div class="d-flex align-items-center gap-5">
			<div>
				<strong>ユーザー名：</strong>
				<span th:text="${session.loginUser.name}"></span>
			</div>
			<div>
				<strong>ユーザーID：</strong>
				<span th:text="${session.loginUser.id}"></span>
			</div>
			<span th:if="${session.loginUser.role =='Regular'|| session.loginUser.role == 'UnitManager'}">
				<div>
					<strong>ステータス：</strong>
					<span th:text="${statusFlg}"></span>
				</div>
			</span>
		</div>
	</div>
	<div th:if="${error}" class="alert alert-danger">
		<p th:text="${error}"></p>
	</div>
	<div th:if="${message}" class="alert alert-info">
		<p th:text="${message}"></p>
	</div>


	<div class="container mt-3 mb-3">
		<div class="row">
			<span th:if="${session.loginUser.role =='Regular'|| session.loginUser.role == 'UnitManager'}">
				<form th:action="@{/attendance/regist/display}" method="get" id="display-form">

					<strong>表示年月：</strong>
					<input type="text" size="15" name="year" id="id_year" />年
					<input type="text" size="15" name="month" id="id_month" />月
					<input type="submit" class="btn-yellow ms-3" value="表示" id="display" />
					<div id="yearError" class="text-danger"></div>
					<div id="monthError" class="text-danger"></div>
					<input type="hidden" name="yearMonth" id="yearMonth" />
				</form>

			</span>

			<div class="d-flex align-items-center position-absolute top-10 start-50">
				<!--	 <div class="mx-auto p-1" style="width: 200px;">-->
				<th:block th:if="${session.loginUser.role == 'Manager'}">
					<button type="submit" form="attendancebtn-form" name="action" value="reject" id="reject-btn"
						class="btn-yellow offset-col-8" disabled>却下</button>
					<button type="submit" form="attendancebtn-form" name="action" value="approve" id="approve-btn"
						class="btn-yellow offset-col-8" disabled>承認</button>
				</th:block>

				<th:block th:if="${session.loginUser.role == 'Regular' || session.loginUser.role == 'UnitManager'}">
					<form action="/attendance/approveRequestComplete" id="approve-form" method="post">
						<input type="hidden" name="yearMonth" id="ApproveYearMonth" />
						<button type="submit" class="btn-yellow offset-col-8"
							th:disabled="${(status == 1 || status == 2) || (status == null && (registCheck == false || registCheck == null))}">承認申請</button>
						<input type="submit" class="btn-yellow ms-1" value="登録" form="attendance-form"
							th:disabled="${status == 1 || status == 2 || displayFlg == true}" />
					</form>
				</th:block>
			</div>



			<th:block th:if="${session.loginUser.role == 'Manager'}">
				<div class="container mt-5 mb-3 border">
					<table class="table table-hover sortabletable dataTable no-footer" id="user-table" role="grid"
						aria-describedby="user-table_info">
						<thead>
							<thead>
								<tr>
									<th>承認申請者</th>
									<th>申請対象年月</th>
									<th>申請日</th>
								</tr>
							</thead>
						<tbody>
							<th:block th:each="MonthlyList : ${monthlyAttendanceReqList}"
								th:if="${MonthlyList.status == 1}">
								<tr>
									<td><a th:href="@{/attendance/approveRequests(userId=${MonthlyList.userId}, 
										targetYearMonth=${MonthlyList.targetYearMonth}, activateButtons=true)}" th:text="${MonthlyList.name}"
											id="requestLink"></a></td>
									<td
										th:text="${#temporals.format(MonthlyList.targetYearMonth.toLocalDate(), 'yyyy/MM')}">
									</td>
									<td th:text="${#temporals.format(MonthlyList.date.toLocalDate(), 'yyyy/MM/dd')}">
									</td>
								</tr>
							</th:block>
						</tbody>
					</table>
				</div>

			</th:block>
			<th:block th:if="${session.loginUser.role == 'Regular' || session.loginUser.role =='UnitManager'}">
				<div class="container mt-3 mb-3 border">
					<th:block>
						<div class="d-flex flex-column" th:each="errorMessage:${errorBox}"
							th:if="${not #strings.isEmpty(errorMessage)}" id="errorMessage">
							<span th:text="'*' + '&nbsp' + ${errorMessage}" class="help-inline error"></span>
						</div>
					</th:block>

					<form th:action="@{/attendance/regist/complete}" method="post" id="attendance-form"
						th:object="${attendanceFormList}">

						<table class="table table-hover sortabletable dataTable no-footer" id="attendance-table"
							role="grid" aria-describedby="attendance-table_info">
							<thead>
								<tr>
									<th>日付</th>
									<th>曜日</th>
									<th>勤務状況</th>
									<th>出勤時間</th>
									<th>退勤時間</th>
									<th>備考</th>
								</tr>
							</thead>
							<tbody>

								<th:block th:each="dailyAttendanceForm, stat: *{attendanceFormList}">
									<th:block>
										<input type="hidden" name="sessionUserId" th:value="${session.loginUser.id}" />
										<input type="hidden" th:name="|attendanceFormList[${stat.index}].date|"
											th:value="${dailyAttendanceForm.date}">
										<input type="hidden" th:name="|attendanceFormList[${stat.index}].userId|"
											th:value="${dailyAttendanceForm.userId != null ? dailyAttendanceForm.userId : ''}" />
										<input type="hidden" th:name="|attendanceFormList[${stat.index}].id|"
											th:value="${dailyAttendanceForm.id != null ? dailyAttendanceForm.id : null}" />

									</th:block>


									<tr>
										<td class="w-10"
											th:text="${#temporals.format(dailyAttendanceForm.date, 'M/d')}"></td>
										<td class="w-10"
											th:text="${T(com.analix.project.util.AttendanceUtil).getJapaneseDayOfWeek(dailyAttendanceForm.date.dayOfWeek)}">
										</td>
										<td class="w-10">

											<select th:name="|attendanceFormList[${stat.index}].status|"
												class="form-select" th:value="${dailyAttendanceForm.status}"
												th:disabled="${status == 1 || status == 2}">
												<!-- dailyAttendance.statusがnullまたは空の場合に空の選択肢を表示 -->
												<option th:value=null th:if="${dailyAttendanceForm.status == null}">
												</option>

												<option value="0" th:selected="${dailyAttendanceForm.status == 0}">通常出勤
												</option>
												<option value="1" th:selected="${dailyAttendanceForm.status == 1}">休日
												</option>
												<option value="2" th:selected="${dailyAttendanceForm.status == 2}">祝日
												</option>
												<option value="3" th:selected="${dailyAttendanceForm.status == 3}">遅刻
												</option>
												<option value="4" th:selected="${dailyAttendanceForm.status == 4}">有給
												</option>
												<option value="5" th:selected="${dailyAttendanceForm.status == 5}">欠勤
												</option>
												<option value="6" th:selected="${dailyAttendanceForm.status == 6}">早退
												</option>
												<option value="7" th:selected="${dailyAttendanceForm.status == 7}">時間外勤務
												</option>
												<option value="8" th:selected="${dailyAttendanceForm.status == 8}">振替出勤
												</option>
												<option value="9" th:selected="${dailyAttendanceForm.status == 9}">振替休日
												</option>
												<option value="10" th:selected="${dailyAttendanceForm.status == 10}">
													代替出勤
												</option>
												<option value="11" th:selected="${dailyAttendanceForm.status == 11}">
													代替休日
												</option>
											</select>


										</td>
										<td class="w-10">
											<input type="text" class="form-control" th:errorclass="is-invalid"
												th:name="|attendanceFormList[${stat.index}].startTime2|"
												th:value="${dailyAttendanceForm.startTime2}"
												th:disabled="${status == 1 || status == 2}" />
											<span class="invalid-feedback" id="startTime-errors"
												th:errors="*{attendanceFormList[__${stat.index}__].startTime2}"></span>


										</td>
										<td class="w-10">
											<input type="text" class="form-control" th:errorclass="is-invalid"
												th:name="|attendanceFormList[${stat.index}].endTime2|"
												th:value="${dailyAttendanceForm.endTime2}"
												th:disabled="${status == 1 || status == 2}" />
											<span class="invalid-feedback" id="endTime-errors"
												th:errors="*{attendanceFormList[__${stat.index}__].endTime2}"></span>
										</td>
										<td class="w-10">
											<input type="text" class="form-control" th:errorclass="is-invalid"
												th:name="|attendanceFormList[${stat.index}].remarks|"
												th:value="${dailyAttendanceForm.remarks}"
												th:disabled="${status == 1 || status == 2}" />
											<span class="error invalid-feedback" id="remarks-errors"
												th:errors="*{attendanceFormList[__${stat.index}__].remarks}"></span>



										</td>
									</tr>
								</th:block>
							</tbody>
						</table>
					</form>
				</div>
			</th:block>

			<!--「承認申請者」押下後 -->
			<th:block th:if="${session.loginUser.role == 'Manager'}">
				<div class="container mt-3 mb-3 border">
					<form id="attendancebtn-form" method="get" th:action="@{/attendance/update}">
						<table class="table table-hover sortabletable dataTable no-footer" id="attendance-table"
							role="grid" aria-describedby="attendance-table_info">
							<thead>
								<tr>
									<th>日付</th>
									<th>曜日</th>
									<th>勤務状況</th>
									<th>出勤時間</th>
									<th>退勤時間</th>
									<th>備考</th>
								</tr>
							</thead>
							<tbody>
								<input type="hidden" id="attendancebtn-form" name="targetYearMonth"
									th:value="${session.targetYearMonth}" />
								<th:block th:each="attendanceReq,stat : ${attendanceList}">
									<th:block>
										<input type="hidden" id="attendancebtn-form" name="userId"
											th:value="${attendanceReq.userId}" />
									</th:block>
									<tr>
										<td th:text="${#temporals.format(attendanceReq.date.toLocalDate(), 'M/d')}">
										</td>
										<td
											th:text="${T(com.analix.project.util.AttendanceUtil).getJapaneseDayOfWeek(attendanceReq.date.toLocalDate().dayOfWeek)}">
										</td>
										<td id="status-${attendanceReq.id}" th:text="${attendanceReq.status}"></td>
										<td
											th:text="${attendanceReq.startTime != null ? #temporals.format(attendanceReq.startTime.toLocalTime(), 'HH:mm') : '-'}">
										</td>
										<td
											th:text="${attendanceReq.endTime != null ? #temporals.format(attendanceReq.endTime.toLocalTime(), 'HH:mm') : '-'}">
										</td>
										<td th:text="${attendanceReq.remarks}"></td>
									</tr>
								</th:block>
							</tbody>
						</table>
					</form>
				</div>

				<script>
					//申請承認後用勤務状況
					var statusList = {
						0: "通常出勤",
						1: "休日",
						2: "祝日",
						3: "遅刻",
						4: "有給",
						5: "欠勤",
						6: "早退",
						7: "時間外勤務",
						8: "振替出勤",
						9: "振替休日",
						10: "代替出勤",
						11: "代替休日",

					};

					function populateStatusDropdown() {
						var dropdowns = document.getElementsByClassName('status-dropdown');
						for (var i = 0; i < dropdowns.length; i++) {
							var dropdown = dropdowns[i];
							var selectedStatus = dropdown.getAttribute('data-status');
							var options = '';

							for (var key in statusList) {
								var selected = (key == selectedStatus) ? ' selected' : '';
								options += "<option value='" + key + "'" + selected + ">" + statusList[key] + "</option>";
							}

							dropdown.innerHTML = options;
						}
					}

					window.onload = populateStatusDropdown;

					// 申請情報確認時に使用
					document.addEventListener('DOMContentLoaded', function () {
						// テーブル内のすべてのstatusセルを取得
						var statusCells = document.querySelectorAll('td[id^="status-"]');

						// 各statusセルのテキストを変換
						statusCells.forEach(function (cell) {
							var statusCode = cell.textContent.trim();
							var statusText = statusList[statusCode] || "不明";
							cell.textContent = statusText;
						});
					});
				</script>

			</th:block>
			<!--(申請情報)-->



			<script>

				//「却下」「承認」ボタンの活性化
				document.addEventListener('DOMContentLoaded', function () {
					const urlParams = new URLSearchParams(window.location.search);
					const activateButtons = urlParams.get('activateButtons');

					if (activateButtons === 'true') {
						document.getElementById('reject-btn').disabled = false;
						document.getElementById('approve-btn').disabled = false;
					}
				});


				// 入力チェック
				document.getElementById('display-form').addEventListener('submit', function (event) {
					let year = document.getElementById('id_year').value;
					let month = document.getElementById('id_month').value;
					let validation = true;

					if (year === "") {
						document.getElementById('yearError').innerHTML = "年を入力してください";
						validation = false;
					} else if (year.length !== 4 || isNaN(year)) {
						document.getElementById('yearError').innerHTML = "yyyyのフォーマットで入力してください";
						validation = false;
					} else {
						document.getElementById('yearError').innerHTML = "";
					}

					if (month === "") {
						document.getElementById('monthError').innerHTML = "月を入力してください";
						validation = false;
					} else if (isNaN(month) || month < 1 || month > 12) {
						document.getElementById('monthError').innerHTML = "MMのフォーマットで入力してください";
						validation = false;
					} else {
						document.getElementById('monthError').innerHTML = "";
					}

					if (!validation) {
						event.preventDefault();
					}
				});
				// 入力内容をローカルストレージに保存
				document.querySelector('#display-form').addEventListener('submit', function (event) {
					var year = document.getElementById('id_year').value;
					var month = document.getElementById('id_month').value;

					// 月を2桁にフォーマット
					if (month.length < 2) {
						month = '0' + month;
					}

					var yearMonth = year + '-' + month;

					var hiddenInput = document.getElementById('yearMonth');
					hiddenInput.value = yearMonth;

					sessionStorage.setItem('year', year);
					sessionStorage.setItem('month', month);
					sessionStorage.setItem('yearMonth', yearMonth);
				});

				// ページ読み込み時にローカルストレージから値を取得して設定
				window.addEventListener('load', function () {
					var storedYear = sessionStorage.getItem('year');
					var storedMonth = sessionStorage.getItem('month');
					var storedYearMonth = localStorage.getItem('yearMonth');


					if (storedYear) {
						document.getElementById('id_year').value = storedYear;
					}
					if (storedMonth) {
						// 月を2桁にフォーマットする
						if (storedMonth.length < 2) {
							storedMonth = '0' + storedMonth;
						}
						document.getElementById('id_month').value = storedMonth;
					}
					if (storedYearMonth) {
						var hiddenInput = document.getElementById('yearMonth');
						if (hiddenInput) {
							hiddenInput.value = storedYearMonth;
						}
					}
				});


			</script>
</body>

</html>